# 功能查重系统使用指南 v2.0

## 📋 系统概述

这是一个基于 **React + Supabase** 的功能查重系统，采用**功能意图归一化**技术，能够准确识别"打开全民K歌搜索山楂树之恋"和"打开全民K歌搜索快乐"是**同一个功能**。

### 🔥 核心特性（v2.0 新增）
- ✅ **功能意图归一化**（Intent Normalization）- 核心算法升级
- ✅ **动词归一化** - 将"打开/进入/启动"统一为"打开"
- ✅ **参数剥离** - 自动识别并剥离歌名、人名等变量
- ✅ **两层查重逻辑** - 意图相似度 + 文本相似度
- ✅ CSV 文件持久化存储
- ✅ 实时检索（上传后立即可搜索）
- ✅ 重启后数据不丢失

---

## 🧠 功能意图归一化原理

### 什么是功能意图？

一个功能由两部分组成：

**1. 功能骨架（Intent Skeleton）** 👈 核心判断依据
- 描述"用户在做什么操作"
- 例如：打开、搜索、播放、点赞、评论、关注

**2. 功能参数（Slots / Variables）** 👈 应被弱化
- 描述"操作对象或内容"
- 例如：歌曲名、作者名、关键词

### 归一化示例

| 原始Query | 归一化后的Intent |
|----------|----------------|
| 打开全民K歌搜索山楂树之恋 | 打开 搜索 |
| 进入全民K歌查找快乐 | 打开 搜索 |
| 启动全民K歌搜一下周杰伦 | 打开 搜索 |

**结论**：虽然搜索内容不同，但**功能骨架相同** → 判定为**同一功能**

---

## 🔄 动词归一化规则

系统内置**动词归一化映射表**，将不同表述统一：

| 归一化后 | 可识别的变体 |
|---------|-------------|
| **打开** | 打开、进入、启动、开启、访问 |
| **搜索** | 搜索、查找、搜一下、找、检索 |
| **播放** | 播放、听、听一下、放、观看、看 |
| **点赞** | 点赞、赞、喜欢 |
| **评论** | 评论、留言、发表评论 |
| **关注** | 关注、订阅、加关注 |
| **分享** | 分享、转发 |
| **收藏** | 收藏、保存 |
| **删除** | 删除、移除 |
| **添加** | 添加、新增、创建 |
| **编辑** | 编辑、修改、更改 |
| **查看** | 查看、浏览、查询 |
| **登录** | 登录、登陆、登入 |
| **退出** | 退出、登出、退出登录 |

---

## 🎯 参数剥离逻辑

系统会自动识别并剥离以下内容：

### 1. 引号/书名号包裹的内容
```
《山楂树之恋》 → <QUERY>
"快乐" → <QUERY>
```

### 2. 明显的专有名词
```
周杰伦 → <QUERY>
晴天 → <QUERY>
```

### 3. 数字和字母序列
```
12345 → <QUERY>
ABC123 → <QUERY>
```

**处理后**：
```
原始：打开全民K歌搜索《山楂树之恋》
剥离：打开 全民K歌 搜索
归一：打开 搜索
```

---

## 🔍 两层查重逻辑（核心算法）

### 第一层：功能是否已定义？

**使用**：`intent_text`（归一化后的功能意图）  
**算法**：TF-IDF + Cosine Similarity  
**阈值**：相似度 > **0.8** → 判定为"功能已定义"  

**结果**：
- ✅ 意图相似度 > 0.8 → 🔴 **功能已定义过**（is_duplicate = true）
- ⚠️ 意图相似度 0.5-0.8 → 🟡 **相似功能**
- ✓ 意图相似度 < 0.5 → 🟢 **不同功能**

### 第二层：表达是否相似？

**使用**：`search_text`（原始完整文本）  
**算法**：TF-IDF + Cosine Similarity  
**作用**：补充排序、展示历史案例  

**不影响"是否已定义"的判断！**

### 排序优先级

```
1. 优先展示重复功能（is_duplicate = true）
2. 按意图相似度排序
3. 意图相似度相同时，按文本相似度排序
```

---

## 📊 数据库设计

### 表结构更新（v2.0）

**function_records** - 存储功能记录
| 字段 | 类型 | 说明 |
|------|------|------|
| id | bigserial | 主键 |
| source_dir | text | CSV所在目录 |
| source_file | text | CSV文件名 |
| row_number | integer | CSV行号 |
| level_1 | text | 一级界面 |
| function_point | text | 具体功能点 |
| sub_function | text | 细分功能点 |
| search_text | text | 原始完整文本（用于补充排序） |
| **intent_text** | **text** | **🆕 归一化后的功能意图（核心查重依据）** |
| created_at | timestamp | 创建时间 |

---

## 🌐 Web界面功能（v2.0）

### 搜索结果展示

每条结果现在包含：

**1. 双重相似度分数**
- 🎯 **意图相似度**：判断功能是否已定义
- 📝 **文本相似度**：展示表达相似程度

**2. 功能状态标识**
- 🔴 **功能已定义**（意图相似度 > 80%）
- 🟡 **相似功能**（意图相似度 50%-80%）
- 🟢 **不同功能**（意图相似度 < 50%）

**3. 归一化意图展示**
```
┌─────────────────────────────────────┐
│ 归一化意图：打开 搜索                │
│ 💡 虽然搜索内容不同，但该功能骨架已存在 │
└─────────────────────────────────────┘
```

**4. 原始Query示例**
- 展示历史记录的原始query
- 帮助用户理解"虽然参数不同但功能相同"

**5. 重复警告**
```
⚠️ 检测到重复功能！
该功能骨架已在历史记录中存在，虽然具体参数可能不同，但核心操作相同。
```

---

## 🚀 使用示例

### 示例1：检测到重复功能

**输入**：
```
打开全民K歌搜索山楂树之恋
```

**系统处理**：
```
1. 归一化意图 → "打开 搜索"
2. 在数据库中找到历史记录：
   - 打开全民K歌搜索快乐（意图相似度 95%）
   - 进入全民K歌查找周杰伦（意图相似度 92%）
```

**结果展示**：
```
⚠️ 功能已定义过！发现重复功能骨架

#1 [功能已定义] 意图: 95.0% 文本: 68.0%
功能意图（归一化后）：打开 搜索
💡 虽然搜索内容不同，但该功能骨架已存在

功能路径：娱乐应用 > 全民K歌 > 搜索功能
原始Query：打开全民K歌搜索快乐
来源：功能清单_v1.csv 第15行
```

### 示例2：未检测到重复

**输入**：
```
点赞评论区的第一条评论
```

**系统处理**：
```
1. 归一化意图 → "点赞 评论"
2. 数据库中没有类似功能（意图相似度都 < 50%）
```

**结果展示**：
```
✓ 找到 5 条相关记录

#1 [不同功能] 意图: 42.0% 文本: 35.0%
功能意图（归一化后）：查看 评论
...
```

---

## 🔧 CSV清洗流程（v2.0）

### 清洗步骤

```
1. CSV解析
   ├─ 删除 "Unnamed: X" 列
   └─ 提取关键列

2. Forward Fill
   ├─ 一级界面
   ├─ 具体功能点
   └─ 细分功能点

3. 构建 search_text（原始完整文本）
   ├─ 拼接：level_1 + function_point + sub_function
   └─ 合并所有query列

4. 🆕 构建 intent_text（归一化意图）
   ├─ 参数剥离（替换为 <QUERY>）
   ├─ 动词归一化（使用映射表）
   ├─ 去重去噪
   └─ 生成最终意图文本
```

### CSV格式示例

```csv
一级界面,具体功能点,细分功能点,示例query,示例query.1,行对应query
娱乐应用,全民K歌,搜索功能,打开全民K歌搜索山楂树之恋,搜索歌曲,音乐搜索
娱乐应用,全民K歌,搜索功能,进入全民K歌查找快乐,搜索歌曲,音乐搜索
娱乐应用,全民K歌,播放功能,播放《晴天》,听歌,播放音乐
```

**处理后**：

| search_text（原始） | intent_text（归一化） |
|-------------------|---------------------|
| 娱乐应用 全民K歌 搜索功能 打开全民K歌搜索山楂树之恋 搜索歌曲 音乐搜索 | 打开 搜索 |
| 娱乐应用 全民K歌 搜索功能 进入全民K歌查找快乐 搜索歌曲 音乐搜索 | 打开 搜索 |
| 娱乐应用 全民K歌 播放功能 播放《晴天》 听歌 播放音乐 | 播放 |

---

## 🎨 界面颜色标识

### 相似度徽章

| 颜色 | 标签 | 条件 | 含义 |
|-----|------|-----|------|
| 🔴 红色 | **功能已定义** | 意图相似度 > 80% | 强烈警告：功能重复！ |
| 🟡 黄色 | **相似功能** | 意图相似度 50%-80% | 建议检查是否重复 |
| 🟢 绿色 | **不同功能** | 意图相似度 < 50% | 可能是新功能 |

### 结果卡片边框

- 🔴 红色双边框 → `is_duplicate = true`（功能已定义）
- ⚪ 默认边框 → 其他情况

---

## 📝 后端Edge Functions（v2.0）

### process-csv（已升级）

**新增功能**：
```typescript
1. 动词归一化
   - 使用 ACTION_NORMALIZATION 映射表
   - 将"打开/进入/启动" → "打开"

2. 参数剥离
   - 识别引号/书名号内容
   - 识别专有名词
   - 替换为 <QUERY> 占位符

3. 生成 intent_text
   - extractIntent(level1, functionPoint, subFunction, queries)
   - normalizeIntent(text)
```

### search-similar（已升级）

**新增逻辑**：
```typescript
1. 用户输入归一化
   queryIntent = normalizeIntent(query)

2. 第一层：意图相似度计算
   intent_similarity = cosineSimilarity(query_intent, record_intent)
   is_duplicate = intent_similarity > 0.8

3. 第二层：文本相似度计算
   text_similarity = cosineSimilarity(query_text, record_text)

4. 双重排序
   - 优先展示 is_duplicate = true
   - 按 intent_similarity 排序
   - 相同时按 text_similarity 排序
```

---

## ⚙️ 配置参数

### 可调整的阈值

```typescript
// 在 search-similar/index.ts 中
const DUPLICATE_THRESHOLD = 0.8;  // 功能重复阈值（默认80%）
const SIMILAR_THRESHOLD = 0.5;     // 相似功能阈值（默认50%）
```

### 动词映射表扩展

如需添加新的动词归一化规则，编辑：
```typescript
// process-csv/index.ts 和 search-similar/index.ts
const ACTION_NORMALIZATION = {
  // 添加新映射
  '您的动词': '归一后的动词',
};
```

---

## 🎯 核心优势

### v2.0 vs v1.0

| 特性 | v1.0（纯文本匹配） | v2.0（意图归一化） |
|-----|------------------|------------------|
| **识别能力** | "打开全民K歌搜索山楂树之恋" ≠ "进入全民K歌查找快乐" | ✅ 识别为同一功能 |
| **参数干扰** | 歌名不同导致相似度低 | ✅ 自动剥离参数 |
| **动词变体** | "打开" ≠ "进入" ≠ "启动" | ✅ 自动归一化 |
| **查重准确性** | 容易误判和漏判 | ✅ 准确识别功能骨架 |
| **用户体验** | 只有一个相似度分数 | ✅ 双重相似度 + 意图展示 |

---

## 🔐 安全说明

当前版本为简化实现，未加权限控制。

**生产环境建议**：
- 添加用户认证
- 设置角色权限
- 限制上传文件大小（建议10MB以内）
- 添加审计日志
- 限制API调用频率

---

## 📞 故障排查

### 问题1：归一化后意图为空

**原因**：输入文本没有可识别的动词  
**解决**：
1. 检查 ACTION_NORMALIZATION 映射表是否包含该动词
2. 手动添加映射规则

### 问题2：明明是同一功能，但未标记为重复

**原因**：意图相似度未达到阈值（0.8）  
**解决**：
1. 检查 CSV 中的功能描述是否规范
2. 适当调低 DUPLICATE_THRESHOLD
3. 丰富动词映射表

### 问题3：误报重复（不同功能被识别为相同）

**原因**：归一化过度，丢失了关键信息  
**解决**：
1. 检查参数剥离逻辑是否过于激进
2. 保留关键名词（如应用名、模块名）
3. 适当提高 DUPLICATE_THRESHOLD

---

## 🎉 总结

v2.0 版本通过**功能意图归一化**技术，实现了：

✅ **准确识别**：无论用户如何表达，只要功能骨架相同就能识别  
✅ **参数无关**：歌名、人名等参数不同不影响判断  
✅ **动词统一**：打开/进入/启动自动识别为同一动作  
✅ **双重验证**：意图相似度 + 文本相似度双重保障  
✅ **清晰展示**：用户能看到归一化后的意图，理解判断依据  

**完美适合**：
- 产品功能管理
- 需求去重
- 用户意图分析
- 对话系统训练数据清洗

---

## 📖 技术栈

**前端**：React 18 + TypeScript + Tailwind CSS + shadcn/ui  
**后端**：Supabase (Database + Storage + Edge Functions)  
**算法**：
- TF-IDF（词频-逆文档频率）
- Cosine Similarity（余弦相似度）
- **Intent Normalization（功能意图归一化）** 🆕
- **Action Normalization（动词归一化）** 🆕
- **Slot Removal（参数剥离）** 🆕

---

版本：v2.0  
更新日期：2025-12-27  
作者：Enter AI Assistant
